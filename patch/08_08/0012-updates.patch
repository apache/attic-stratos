From bd6b50166728f15077cb6ebe561786efcc502706 Mon Sep 17 00:00:00 2001
From: gayan <gayan@puppet.gayan.org>
Date: Wed, 6 Aug 2014 17:21:12 +0530
Subject: [PATCH 12/30] updates

---
 .../metadataservice/listener/TopologyListener.java | 53 ++--------------------
 1 file changed, 5 insertions(+), 48 deletions(-)

diff --git a/components/org.apache.stratos.metadataservice/src/main/java/org/apache/stratos/metadataservice/listener/TopologyListener.java b/components/org.apache.stratos.metadataservice/src/main/java/org/apache/stratos/metadataservice/listener/TopologyListener.java
index 14faf65..2f09d3d 100644
--- a/components/org.apache.stratos.metadataservice/src/main/java/org/apache/stratos/metadataservice/listener/TopologyListener.java
+++ b/components/org.apache.stratos.metadataservice/src/main/java/org/apache/stratos/metadataservice/listener/TopologyListener.java
@@ -6,18 +6,15 @@ import javax.servlet.ServletContextListener;
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
 import org.apache.stratos.messaging.event.Event;
-import org.apache.stratos.messaging.event.topology.CompleteTopologyEvent;
-import org.apache.stratos.messaging.event.topology.MemberActivatedEvent;
 import org.apache.stratos.messaging.event.topology.MemberStartedEvent;
 import org.apache.stratos.messaging.event.topology.MemberSuspendedEvent;
 import org.apache.stratos.messaging.event.topology.MemberTerminatedEvent;
-import org.apache.stratos.messaging.listener.topology.CompleteTopologyEventListener;
-import org.apache.stratos.messaging.listener.topology.MemberActivatedEventListener;
 import org.apache.stratos.messaging.listener.topology.MemberStartedEventListener;
 import org.apache.stratos.messaging.listener.topology.MemberSuspendedEventListener;
 import org.apache.stratos.messaging.listener.topology.MemberTerminatedEventListener;
 import org.apache.stratos.messaging.message.receiver.topology.TopologyEventReceiver;
 import org.apache.stratos.messaging.message.receiver.topology.TopologyManager;
+import org.apache.stratos.metadataservice.services.MetaDataAdmin;
 
 public class TopologyListener implements ServletContextListener {
 
@@ -52,25 +49,6 @@ public class TopologyListener implements ServletContextListener {
 			log.debug("Starting topology event message receiver thread");
 		}
 		TopologyEventReceiver topologyEventReceiver = new TopologyEventReceiver();
-		topologyEventReceiver.addEventListener(new MemberActivatedEventListener() {
-			@Override
-			protected void onEvent(Event event) {
-				try {
-					TopologyManager.acquireReadLock();
-					if (log.isDebugEnabled()) {
-						log.debug("Member activated event received");
-					}
-					MemberActivatedEvent memberActivatedEvent = (MemberActivatedEvent) event;
-					// extensionHandler.onMemberActivatedEvent(memberActivatedEvent);
-				} catch (Exception e) {
-					if (log.isErrorEnabled()) {
-						log.error("Error processing member activated event", e);
-					}
-				} finally {
-					TopologyManager.releaseReadLock();
-				}
-			}
-		});
 
 		topologyEventReceiver.addEventListener(new MemberTerminatedEventListener() {
 			@Override
@@ -81,6 +59,10 @@ public class TopologyListener implements ServletContextListener {
 						log.debug("Member terminated event received");
 					}
 					MemberTerminatedEvent memberTerminatedEvent = (MemberTerminatedEvent) event;
+					System.out.println("Terminated event :::::::::::::::::::: " +
+					                   memberTerminatedEvent.getServiceName());
+					new MetaDataAdmin().removeCartridgeMetaDataDetails("appA", "php");
+
 					// extensionHandler.onMemberTerminatedEvent(memberTerminatedEvent);
 				} catch (Exception e) {
 					if (log.isErrorEnabled()) {
@@ -112,31 +94,6 @@ public class TopologyListener implements ServletContextListener {
 			}
 		});
 
-		topologyEventReceiver.addEventListener(new CompleteTopologyEventListener() {
-			private boolean initialized;
-
-			@Override
-			protected void onEvent(Event event) {
-				if (!initialized) {
-					try {
-						TopologyManager.acquireReadLock();
-						if (log.isDebugEnabled()) {
-							log.debug("Complete topology event received");
-						}
-						CompleteTopologyEvent completeTopologyEvent = (CompleteTopologyEvent) event;
-						// extensionHandler.onCompleteTopologyEvent(completeTopologyEvent);
-						initialized = true;
-					} catch (Exception e) {
-						if (log.isErrorEnabled()) {
-							log.error("Error processing complete topology event", e);
-						}
-					} finally {
-						TopologyManager.releaseReadLock();
-					}
-				}
-			}
-		});
-
 		topologyEventReceiver.addEventListener(new MemberStartedEventListener() {
 			@Override
 			protected void onEvent(Event event) {
-- 
1.9.1

