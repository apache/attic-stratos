From f3d5f58970ae20c724cd8d73906f41505c6b73c5 Mon Sep 17 00:00:00 2001
From: gayan <gayan@puppet.gayan.org>
Date: Wed, 6 Aug 2014 18:10:39 +0530
Subject: [PATCH 14/30] updates

---
 .../metadataservice/services/MetaDataAdmin.java    | 110 +++------------------
 1 file changed, 14 insertions(+), 96 deletions(-)

diff --git a/components/org.apache.stratos.metadataservice/src/main/java/org/apache/stratos/metadataservice/services/MetaDataAdmin.java b/components/org.apache.stratos.metadataservice/src/main/java/org/apache/stratos/metadataservice/services/MetaDataAdmin.java
index d441e0e..36316f2 100644
--- a/components/org.apache.stratos.metadataservice/src/main/java/org/apache/stratos/metadataservice/services/MetaDataAdmin.java
+++ b/components/org.apache.stratos.metadataservice/src/main/java/org/apache/stratos/metadataservice/services/MetaDataAdmin.java
@@ -1,8 +1,6 @@
 package org.apache.stratos.metadataservice.services;
 
 import java.io.File;
-import java.util.ArrayList;
-import java.util.List;
 
 import javax.servlet.http.HttpServletRequest;
 import javax.ws.rs.Consumes;
@@ -18,14 +16,11 @@ import org.apache.axis2.context.ConfigurationContextFactory;
 import org.apache.commons.configuration.XMLConfiguration;
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
+import org.apache.stratos.metadataservice.Registry.DataRegistryFactory;
 import org.apache.stratos.metadataservice.annotation.AuthorizationAction;
 import org.apache.stratos.metadataservice.definition.CartridgeMetaData;
-import org.apache.stratos.metadataservice.definition.PropertyBean;
 import org.apache.stratos.metadataservice.exception.RestAPIException;
 import org.apache.stratos.metadataservice.util.ConfUtil;
-import org.wso2.carbon.registry.api.Registry;
-import org.wso2.carbon.registry.api.Resource;
-import org.wso2.carbon.registry.core.Comment;
 import org.wso2.carbon.registry.ws.client.registry.WSRegistryServiceClient;
 
 @Path("/metadataservice/")
@@ -81,53 +76,11 @@ public class MetaDataAdmin {
 	public String addCartridgeMetaDataDetails(@PathParam("applicationname") String applicationName,
 	                                          @PathParam("cartridgetype") String cartridgeType,
 	                                          CartridgeMetaData cartridgeMetaData) throws Exception {
-		System.out.println("Adding meta data details");
-		Registry registry = setRegistry();
-		try {
 
-			Resource resource = registry.newResource();
-
-			String type = cartridgeMetaData.type;
-
-			resource.setContent("Application description :: " + type);
-
-			String resourcePath = mainResource + applicationName + "/" + cartridgeType;
-
-			resource.addProperty("Application Name", cartridgeMetaData.applicationName);
-			resource.addProperty("Display Name", cartridgeMetaData.displayName);
-			resource.addProperty("Description", cartridgeMetaData.description);
-			resource.addProperty("Cartidge Type", cartridgeMetaData.type);
-			resource.addProperty("provider", cartridgeMetaData.provider);
-			resource.addProperty("Version", cartridgeMetaData.version);
-			resource.addProperty("host", cartridgeMetaData.host);
-
-			for (PropertyBean prop : cartridgeMetaData.property) {
-				resource.addProperty("hostname", prop.hostname);
-				resource.addProperty("username", prop.username);
-				resource.addProperty("password", prop.password);
-			}
-
-			registry.put(resourcePath, resource);
-
-			System.out.println("A resource added to: " + resourcePath);
-
-			System.out.println(cartridgeMetaData.type);
-			registry.rateResource(resourcePath, defaultRank);
-
-			Comment comment = new Comment();
-			comment.setText("Added the " + applicationName + " " + type + " cartridge");
-			registry.addComment(resourcePath, comment);
-
-		} catch (Exception e) {
-
-			System.out.println(e.getMessage());
-			e.printStackTrace();
-		} finally {
-			// Close the session
-			((WSRegistryServiceClient) registry).logut();
-		}
-		System.out.println("Add meta data details");
-		return "success";
+		String registryType = "GREG";
+		return DataRegistryFactory.getDataRegistryFactory(registryType)
+		                          .addCartridgeMetaDataDetails(applicationName, cartridgeType,
+		                                                       cartridgeMetaData);
 
 	}
 
@@ -140,54 +93,19 @@ public class MetaDataAdmin {
 	                                          @PathParam("cartridgetype") String cartridgeType)
 
 	throws Exception {
-		Registry registry = setRegistry();
-		CartridgeMetaData cartridgeMetaData = new CartridgeMetaData();
-		try {
-
-			String resourcePath = mainResource + applicationName + "/" + cartridgeType;
-			if (registry.resourceExists(resourcePath)) {
-
-				Resource getResource = registry.get(resourcePath);
-				System.out.println("Resource retrived");
-				System.out.println("Printing retrieved resource content: " +
-				                   new String((byte[]) getResource.getContent()));
-
-				cartridgeMetaData.type = getResource.getProperty("Cartidge Type");
-				cartridgeMetaData.applicationName = getResource.getProperty("Application Name");
-				cartridgeMetaData.description = getResource.getProperty("Description");
-				cartridgeMetaData.displayName = getResource.getProperty("Display Name");
-				cartridgeMetaData.host = getResource.getProperty("host");
-				cartridgeMetaData.provider = getResource.getProperty("provider");
-				cartridgeMetaData.version = getResource.getProperty("Version");
-
-				List<PropertyBean> lst = new ArrayList<PropertyBean>();
-				PropertyBean prop = new PropertyBean();
-				prop.hostname = getResource.getProperty("hostname");
-				prop.username = getResource.getProperty("username");
-				prop.password = getResource.getProperty("password");
-				lst.add(prop);
-
-				cartridgeMetaData.property = lst;
-
-			}
-
-		} catch (Exception e) {
-
-			System.out.println(e.getMessage());
-			e.printStackTrace();
-		} finally {
-			// Close the session
-			((WSRegistryServiceClient) registry).logut();
-		}
-		return cartridgeMetaData.toString();
+
+		String registryType = "GREG";
+		return DataRegistryFactory.getDataRegistryFactory(registryType)
+		                          .getCartridgeMetaDataDetails(applicationName, cartridgeType);
+
 	}
 
 	public boolean removeCartridgeMetaDataDetails(String applicationName, String cartridgeType)
 	                                                                                           throws Exception {
-		Registry registry = setRegistry();
-		String resourcePath = mainResource + applicationName + "/" + cartridgeType;
-		registry.delete(resourcePath);
-		return false;
+
+		String registryType = "GREG";
+		return DataRegistryFactory.getDataRegistryFactory(registryType)
+		                          .removeCartridgeMetaDataDetails(applicationName, cartridgeType);
 
 	}
 }
-- 
1.9.1

